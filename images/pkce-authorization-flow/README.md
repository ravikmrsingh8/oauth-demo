## PKCE: What and Why?

PKCE (Proof key for Code Exchange) is a new, secure authorization flow (based on the OAuth 2.0 Spec) that was originally created to better secure mobile apps, but is valuable across all OAuth client. 

The most common and secure OAuth flow is the [Authorization code flow](/standard-authorization-flow/README.md). Unfortunately, that process relies on apps providing a <code>client_secret</code> in the final request for an access token. Certain types of apps like mobile apps, desktop apps or  single-page-apps in java script they can have the risk of leaking the <code>client_secret</code>. Because these are public clients, there’s no way for them to guarantee the security of the secret used for the token exchange.

Public clients can take advantage of the authorization code flow by using PKCE, which works by substituting the static client secret with a string that is dynamically generated. By doing so, the PKCE flow eliminates leaky secrets while allowing the authorization server to verify that the app requesting the access token is the same one that initiated the OAuth flow.

### Understanding PKCE Implementation
Building on top of the  [Authorization code flow](/standard-authorization-flow/README.md), there are three new parameters used by PKCE: <code>code_verifier</code>, <code>code_challenge</code>, and <code>code_challenge_method</code>.


**Code Verifier**

The <code>code_verifier</code> is a cryptographically random string generated by your app. This dynamically created string is used to correlate the final access token request with the initial authorization request. In other words, the <code>code_verifier</code> is how the authorization server ensures that the access token is issued to the same app that requested authorization.


**code_challenge**

The <code>code_challenge</code> is derived from the <code>code_verifier</code> using one of the two possible transformations: **plain** and **S256**. Plain can only be used when S256 is not possible. For the majority of use cases, the <code>code_challenge</code> will be a base 64 encoding of an SHA256 hash made with the <code>client_verifier</code>. This string gets decrypted server-side and is used to verify that the requests are coming from the same client.

**code_challenge_method**

The <code>code_challenge_method</code> tells the server which function was used to transform the <code>code_verifier</code> (plain or S256). It will default to plain if left empty.


When a user kicks off a PKCE authorization flow in your app, here’s what takes place.

1. The client creates and records a secret named  <code>code_verifier</code>, shown in figure 10.1 as a flag with a magic wand on it. The client then computes <code>code_challenge</code> based on the <code>code_verifier</code>. The client sends the <code>code_challenge</code> and an optional <code>code_challenge_method</code> (a keyword for plain or SHA-256 hash) along with the regular authorization request parameters to the authorization server

    ![image info](/images/pkce-authorization-flow/pkce_code_challenge.jpg)

2. The authorization server responds as usual but records <code>code_challenge</code> and the <code>code_challenge_method</code> (if present). These are associated with the authorization code that was issued by the authorization server.

3. When the client receives the authorization code, it makes a token request as usual and includes the <code>code_verifier</code> secret that it previously generated

    ![image info](/images/pkce-authorization-flow/pkce_token_req.jpg)

4. The server recomputes the <code>code_challenge</code>, and checks to see whether it matches the original. An error response is returned if they aren’t equal, and the transaction continues as normal if they are.
    
    ![image info](/images/pkce-authorization-flow/auth_server_verifies_code.jpg)


<hr />

PKCE is intended for use with public clients, confidential clients can use this method as well. Checkout the [Sample code & PKCE Flow](./pkce-in-action.md)


![image info](/images/pkce-authorization-flow/pkce-detailed-flow.jpg)